<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ANALYST â€” Session-Aware RAG</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#07080d;--surface:#0c0d14;--surface2:#111320;--surface3:#151826;
      --border:#1c1f2e;--border2:#252840;
      --accent:#4ade80;--accent2:#86efac;--accent-dim:#1a4a28;
      --blue:#38bdf8;--blue-dim:#0c2d3e;
      --yellow:#fbbf24;--red:#f87171;--red-dim:#3b0f0f;
      --muted:#4a5066;--muted2:#6b7291;
      --text:#d4d8f0;--text-dim:#8890b0;
      --fm:'IBM Plex Mono',monospace;--fs:'IBM Plex Sans',sans-serif;
      --hh:54px;--sb:28px;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    html{font-size:15px;}
    html,body{height:100%;overflow:hidden;}
    body{font-family:var(--fs);font-size:1rem;background:var(--bg);color:var(--text);line-height:1.55;}
    body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.022) 2px,rgba(0,0,0,.022) 4px);pointer-events:none;z-index:9000;}
    ::-webkit-scrollbar{width:4px;height:4px;}
    ::-webkit-scrollbar-track{background:transparent;}
    ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

    /* â”€â”€â”€ LAUNCH SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #launchScreen{
      position:fixed;inset:0;background:var(--bg);z-index:8000;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      transition:opacity .65s ease,transform .65s ease;
    }
    #launchScreen.hiding{opacity:0;transform:scale(1.05);pointer-events:none;}

    .ls-grid{
      position:absolute;inset:0;
      background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
      background-size:52px 52px;opacity:.3;
    }
    .ls-glow{
      position:absolute;width:560px;height:560px;border-radius:50%;
      background:radial-gradient(circle,rgba(74,222,128,.07) 0%,transparent 70%);
      top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;
      animation:glowpulse 3.2s ease-in-out infinite;
    }
    @keyframes glowpulse{0%,100%{opacity:.6;transform:translate(-50%,-50%) scale(1)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.18)}}

    .ls-inner{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:26px;}

    .ls-logo{width:60px;height:60px;display:grid;grid-template-columns:1fr 1fr;gap:6px;}
    .ls-logo span{border-radius:3px;background:var(--accent);animation:flicker 2s infinite;}
    .ls-logo span:nth-child(2){animation-delay:.25s;background:var(--blue);}
    .ls-logo span:nth-child(3){animation-delay:.5s;background:var(--blue);}
    .ls-logo span:nth-child(4){animation-delay:.75s;background:var(--accent);}
    @keyframes flicker{0%,100%{opacity:1}50%{opacity:.45}}

    .ls-title{font-family:var(--fm);font-size:2.8rem;font-weight:600;letter-spacing:.15em;color:var(--text);}
    .ls-title em{color:var(--accent);font-style:normal;}
    .ls-sub{font-family:var(--fm);font-size:.72rem;color:var(--muted2);letter-spacing:.1em;}

    .ls-boot{font-family:var(--fm);font-size:.72rem;width:340px;text-align:left;min-height:100px;}
    .boot-line{opacity:0;animation:bfade .3s ease forwards;padding:2px 0;}
    .boot-line.ok{color:var(--accent);}
    .boot-line.info{color:var(--blue);}
    .boot-line.sys{color:var(--text-dim);}
    @keyframes bfade{to{opacity:1}}

    .ls-divider{width:260px;height:1px;background:linear-gradient(90deg,transparent,var(--border2),transparent);}

    .ls-feats{display:flex;gap:26px;font-family:var(--fm);font-size:.7rem;color:var(--muted);}
    .ls-feat{display:flex;align-items:center;gap:7px;}
    .ls-dot{width:5px;height:5px;border-radius:50%;background:var(--accent);}
    .ls-dot.b{background:var(--blue);}
    .ls-dot.y{background:var(--yellow);}

    .ls-btn{
      margin-top:6px;background:var(--accent-dim);border:1px solid var(--accent);
      color:var(--accent);border-radius:4px;padding:15px 44px;
      font-family:var(--fm);font-size:.95rem;font-weight:600;cursor:pointer;
      letter-spacing:.08em;transition:all .2s;position:relative;overflow:hidden;
    }
    .ls-btn::before{content:'';position:absolute;inset:0;background:var(--accent);transform:scaleX(0);transform-origin:left;transition:transform .25s ease;}
    .ls-btn:hover:not(:disabled)::before{transform:scaleX(1);}
    .ls-btn:hover:not(:disabled){color:var(--bg);}
    .ls-btn:disabled{opacity:.4;cursor:not-allowed;}
    .ls-btn span{position:relative;z-index:1;}

    .ls-ver{font-family:var(--fm);font-size:.63rem;color:var(--muted);letter-spacing:.05em;}

    /* â”€â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #mainApp{display:flex;flex-direction:column;height:100vh;opacity:0;transition:opacity .5s ease .12s;}
    #mainApp.visible{opacity:1;}

    /* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #header{
      height:var(--hh);background:var(--surface);border-bottom:1px solid var(--border);
      display:flex;align-items:stretch;padding:0 0 0 16px;flex-shrink:0;
    }
    .h-brand{display:flex;align-items:center;gap:12px;padding-right:18px;border-right:1px solid var(--border);flex-shrink:0;}
    .h-logo{width:26px;height:26px;display:grid;grid-template-columns:1fr 1fr;gap:3px;}
    .h-logo span{border-radius:1px;background:var(--accent);animation:flicker 4s infinite;}
    .h-logo span:nth-child(2){animation-delay:.3s;background:var(--blue);}
    .h-logo span:nth-child(3){animation-delay:.6s;background:var(--blue);}
    .h-logo span:nth-child(4){animation-delay:.9s;background:var(--accent);}
    .h-name{font-family:var(--fm);font-weight:600;font-size:.9rem;letter-spacing:.12em;color:var(--text);}
    .h-tag{font-family:var(--fm);font-size:.6rem;color:var(--muted);letter-spacing:.06em;}

    .h-session{display:flex;align-items:center;padding:0 18px;gap:14px;border-right:1px solid var(--border);}
    .h-slabel{font-family:var(--fm);font-size:.65rem;color:var(--muted);letter-spacing:.07em;}
    .h-sid{font-family:var(--fm);font-size:.65rem;color:var(--accent);}

    .h-files{display:flex;align-items:center;gap:7px;padding:0 18px;overflow-x:auto;scrollbar-width:none;flex:1;}
    .h-files::-webkit-scrollbar{display:none;}

    .file-chip{
      display:inline-flex;align-items:center;gap:6px;
      background:var(--surface2);border:1px solid var(--border2);border-radius:3px;
      padding:4px 10px;font-family:var(--fm);font-size:.65rem;color:var(--text-dim);white-space:nowrap;flex-shrink:0;
    }
    .fc-icon{color:var(--accent);}
    .fc-status{font-size:.58rem;}
    .fc-proc{animation:blink 1s infinite;}
    @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

    .h-right{display:flex;align-items:center;gap:10px;padding:0 16px;border-left:1px solid var(--border);margin-left:auto;flex-shrink:0;}
    .stat-pill{
      display:flex;align-items:center;gap:7px;background:var(--surface2);
      border:1px solid var(--border);border-radius:3px;padding:5px 12px;
      font-family:var(--fm);font-size:.65rem;color:var(--muted2);
    }
    .stat-val{color:var(--accent);font-weight:600;}

    /* attach button */
    .atw{position:relative;}
    .atbtn{
      width:38px;height:38px;background:var(--surface2);border:1px solid var(--border2);
      border-radius:3px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;color:var(--muted2);transition:all .15s;
    }
    .atbtn:hover{border-color:var(--accent);color:var(--accent);}
    .atbtn svg{width:17px;height:17px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}
    .attip{
      position:absolute;bottom:calc(100% + 9px);left:50%;transform:translateX(-50%);
      background:var(--surface3);border:1px solid var(--border2);border-radius:4px;
      padding:7px 13px;font-family:var(--fm);font-size:.63rem;color:var(--text-dim);
      white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:300;
    }
    .attip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:var(--border2);}
    .atw:hover .attip{opacity:1;}
    .atbtn.nosess{animation:nosessflash .55s ease;}
    @keyframes nosessflash{0%,100%{border-color:var(--border2);color:var(--muted2)}35%,65%{border-color:var(--red);color:var(--red)}}

    .new-chat-btn{
      background:var(--accent-dim);border:1px solid var(--accent);color:var(--accent);
      border-radius:3px;padding:7px 15px;font-family:var(--fm);font-size:.7rem;
      font-weight:600;cursor:pointer;letter-spacing:.05em;transition:all .15s;
    }
    .new-chat-btn:hover{background:var(--accent);color:var(--bg);}

    /* â”€â”€â”€ APP LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #appLayout{display:flex;flex:1;overflow:hidden;min-height:0;}

    /* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sidebar{width:248px;border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--surface);flex-shrink:0;}
    .sb-label{font-family:var(--fm);font-size:.6rem;color:var(--muted);letter-spacing:.1em;padding:12px 14px 8px;border-bottom:1px solid var(--border);}
    #convList{flex:1;overflow-y:auto;padding:7px;}
    .conv-item{padding:11px 12px;border-radius:3px;cursor:pointer;border-left:2px solid transparent;transition:all .15s;margin-bottom:3px;}
    .conv-item:hover{background:var(--surface2);border-left-color:var(--border2);}
    .conv-item.active{background:var(--surface2);border-left-color:var(--accent);}
    .conv-title{font-size:.82rem;font-weight:500;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:5px;}
    .conv-meta{font-family:var(--fm);font-size:.6rem;color:var(--muted);display:flex;gap:8px;align-items:center;}
    .doc-badge{background:var(--blue-dim);color:var(--blue);border:1px solid var(--blue);padding:1px 5px;border-radius:2px;font-size:.54rem;}

    /* â”€â”€â”€ CHAT MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chatMain{flex:1;display:flex;flex-direction:column;overflow:hidden;background:var(--bg);}
    .toolbar{
      height:42px;background:var(--surface);border-bottom:1px solid var(--border);
      display:flex;align-items:center;padding:0 22px;gap:14px;flex-shrink:0;
    }
    .tlabel{font-family:var(--fm);font-size:.6rem;color:var(--muted);letter-spacing:.1em;}
    .rdot{width:7px;height:7px;border-radius:50%;background:var(--muted);}
    .rdot.sql{background:var(--accent);}
    .rdot.doc{background:var(--blue);}
    .rdot.hyb{background:var(--yellow);}
    .rtxt{font-family:var(--fm);font-size:.67rem;}

    #chatMessages{flex:1;overflow-y:auto;padding:30px 36px;display:flex;flex-direction:column;gap:2px;}

    /* session placeholder */
    .sess-ph{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:20px;opacity:.5;}
    .sess-ph-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;width:42px;height:42px;}
    .sess-ph-grid span{border-radius:2px;background:var(--accent);}
    .sess-ph-grid span:nth-child(2),.sess-ph-grid span:nth-child(3){background:var(--blue);}
    .sess-ph-title{font-family:var(--fm);font-size:.93rem;color:var(--text-dim);letter-spacing:.07em;}
    .sess-ph-sub{font-size:.82rem;color:var(--muted);text-align:center;max-width:360px;}

    /* messages */
    .msg-group{display:flex;flex-direction:column;gap:3px;margin-bottom:22px;animation:msgin .22s ease;}
    @keyframes msgin{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .msg-hdr{font-family:var(--fm);font-size:.6rem;color:var(--muted);display:flex;align-items:center;gap:10px;padding:0 4px;margin-bottom:6px;}
    .msg-role{letter-spacing:.06em;}
    .msg-role.user{color:var(--blue);}
    .msg-role.assistant{color:var(--accent);}
    .rtag{border-radius:2px;padding:1px 6px;font-size:.55rem;font-weight:600;letter-spacing:.05em;}
    .rtag-sql{background:var(--accent-dim);color:var(--accent);border:1px solid var(--accent);}
    .rtag-doc{background:var(--blue-dim);color:var(--blue);border:1px solid var(--blue);}
    .rtag-hyb{background:#2d1e05;color:var(--yellow);border:1px solid var(--yellow);}

    .msg-bubble{padding:15px 19px;border-radius:3px;max-width:82%;font-size:.95rem;line-height:1.78;position:relative;}
    .msg-bubble.user{
      align-self:flex-end;background:var(--blue-dim);border:1px solid var(--blue);
      border-right:3px solid var(--blue);color:var(--text);font-family:var(--fm);font-size:.82rem;
    }
    .msg-bubble.assistant{align-self:flex-start;background:var(--surface2);border:1px solid var(--border2);border-left:3px solid var(--accent);color:var(--text);}
    .msg-bubble.user::before{content:'> ';font-family:var(--fm);color:var(--blue);}

    /* markdown */
    .mc{word-wrap:break-word;}
    .mc>*:first-child{margin-top:0!important;}
    .mc>*:last-child{margin-bottom:0!important;}
    .mc h1,.mc h2,.mc h3{font-family:var(--fm);margin-top:16px;margin-bottom:9px;color:var(--accent2);font-size:.95em;letter-spacing:.04em;}
    .mc p{margin-bottom:9px;margin-top:9px;}
    .mc strong{color:var(--accent2);font-weight:600;}
    .mc em{color:var(--text-dim);font-style:italic;}
    .mc ul,.mc ol{margin-left:22px;margin-bottom:10px;}
    .mc li{margin-bottom:5px;}
    .mc ul li{list-style-type:none;}
    .mc ul li::before{content:'â†’ ';color:var(--accent);font-family:var(--fm);font-size:.85em;}
    .mc code{background:var(--surface3);border:1px solid var(--border2);padding:2px 6px;border-radius:2px;font-family:var(--fm);font-size:.88em;color:var(--blue);}
    .mc pre{background:var(--surface3);border:1px solid var(--border2);padding:13px 16px;border-radius:3px;overflow-x:auto;margin:12px 0;}
    .mc pre code{background:transparent;border:none;padding:0;}
    .mc blockquote{border-left:2px solid var(--accent);padding-left:14px;margin:12px 0;color:var(--muted2);}
    .mc table{border-collapse:collapse;width:100%;margin:12px 0;font-size:.9em;}
    .mc th,.mc td{border:1px solid var(--border2);padding:8px 13px;}
    .mc th{background:var(--surface3);color:var(--accent2);font-family:var(--fm);font-size:.8em;}
    .mc hr{border:none;border-top:1px solid var(--border2);margin:16px 0;}

    /* chart */
    .chart-box{margin:14px 0;padding:18px;background:var(--surface);border:1px solid var(--border2);border-left:3px solid var(--accent);border-radius:3px;}
    .chart-box canvas{max-width:100%;max-height:400px;}
    .chart-dl{margin-top:12px;padding:6px 14px;background:var(--accent-dim);color:var(--accent);border:1px solid var(--accent);border-radius:3px;cursor:pointer;font-family:var(--fm);font-size:.67rem;font-weight:600;transition:all .15s;}
    .chart-dl:hover{background:var(--accent);color:var(--bg);}

    /* â”€â”€â”€ INPUT AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #inputArea{background:var(--surface);border-top:1px solid var(--border);padding:15px 22px;flex-shrink:0;}
    .input-row{display:flex;gap:10px;align-items:flex-end;}

    .iatw{position:relative;flex-shrink:0;}
    .iatbtn{
      width:46px;height:46px;background:var(--surface2);border:1px solid var(--border2);
      border-radius:3px;display:flex;align-items:center;justify-content:center;
      cursor:pointer;color:var(--muted2);transition:all .15s;
    }
    .iatbtn:hover{border-color:var(--accent);color:var(--accent);}
    .iatbtn svg{width:19px;height:19px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}
    .iattip{
      position:absolute;bottom:calc(100% + 9px);left:50%;transform:translateX(-50%);
      background:var(--surface3);border:1px solid var(--border2);border-radius:4px;
      padding:8px 13px;font-family:var(--fm);font-size:.63rem;color:var(--text-dim);
      white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:300;
    }
    .iattip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:var(--border2);}
    .iatw:hover .iattip{opacity:1;}
    .iatbtn.nosess{animation:nosessflash .55s ease;}

    #messageInput{
      flex:1;background:var(--surface2);border:1px solid var(--border2);border-radius:3px;
      color:var(--text);font-family:var(--fm);font-size:.82rem;padding:12px 14px;
      resize:none;outline:none;max-height:130px;transition:border .15s;line-height:1.5;
    }
    #messageInput:focus{border-color:var(--accent);}
    #messageInput::placeholder{color:var(--muted);}

    #sendBtn{
      background:var(--accent-dim);border:1px solid var(--accent);color:var(--accent);
      border-radius:3px;padding:12px 22px;font-family:var(--fm);font-size:.75rem;
      font-weight:600;cursor:pointer;letter-spacing:.06em;transition:all .15s;height:46px;white-space:nowrap;
    }
    #sendBtn:hover:not(:disabled){background:var(--accent);color:var(--bg);}
    #sendBtn:disabled{opacity:.4;cursor:not-allowed;}

    .input-hint{font-family:var(--fm);font-size:.6rem;color:var(--muted);margin-top:8px;letter-spacing:.04em;display:flex;align-items:center;gap:12px;}
    .ih-sep{color:var(--border2);}

    /* â”€â”€â”€ STATUS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #statusBar{
      height:var(--sb);background:var(--surface);border-top:1px solid var(--border);
      display:flex;align-items:center;padding:0 18px;gap:18px;
      font-family:var(--fm);font-size:.6rem;color:var(--muted);letter-spacing:.05em;flex-shrink:0;
    }
    .sb-item{display:flex;align-items:center;gap:7px;}
    .sb-dot{width:5px;height:5px;border-radius:50%;background:var(--accent);animation:blink 2.5s infinite;}
    .sb-sep{color:var(--border2);}

    /* â”€â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .notif{
      position:fixed;bottom:54px;right:18px;padding:11px 18px;border-radius:3px;
      font-family:var(--fm);font-size:.73rem;z-index:9001;animation:nfin .2s ease;
      display:flex;align-items:center;gap:10px;max-width:360px;
    }
    @keyframes nfin{from{transform:translateX(120px);opacity:0}to{transform:translateX(0);opacity:1}}
    .notif.success{background:var(--accent-dim);border:1px solid var(--accent);color:var(--accent);}
    .notif.error{background:var(--red-dim);border:1px solid var(--red);color:var(--red);}
    .notif.info{background:var(--blue-dim);border:1px solid var(--blue);color:var(--blue);}

    #fileInput{display:none;}

    @media(max-width:768px){#sidebar{display:none;}}
  </style>
</head>
<body>

<!-- â•â• LAUNCH SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="launchScreen">
  <div class="ls-grid"></div>
  <div class="ls-glow"></div>
  <div class="ls-inner">
    <div class="ls-logo"><span></span><span></span><span></span><span></span></div>
    <div>
      <div class="ls-title">ANAL<em>YST</em></div>
    </div>
    <div class="ls-sub">SESSION-AWARE BUSINESS INTELLIGENCE</div>
    <div class="ls-boot" id="lsBoot"></div>
    <div class="ls-divider"></div>
    <div class="ls-feats">
      <div class="ls-feat"><div class="ls-dot"></div>SQL ROUTING</div>
      <div class="ls-feat"><div class="ls-dot b"></div>DOC RAG</div>
      <div class="ls-feat"><div class="ls-dot y"></div>CHARTS</div>
    </div>
    <button class="ls-btn" id="lsBtn" onclick="startApp()" disabled>
      <span id="lsBtnTxt">INITIALIZINGâ€¦</span>
    </button>
    <div class="ls-ver">ANALYST v2.0 &nbsp;Â·&nbsp; READY WHEN YOU ARE</div>
  </div>
</div>

<!-- â•â• MAIN APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainApp">

  <header id="header">
    <div class="h-brand">
      <div class="h-logo"><span></span><span></span><span></span><span></span></div>
      <div>
        <div class="h-name">ANALYST</div>
        <div class="h-tag">SESSION-AWARE RAG</div>
      </div>
    </div>

    <div class="h-session">
      <span class="h-slabel">SESSION</span>
      <span class="h-sid" id="currentSessionBadge">â€”</span>
    </div>

    <div class="h-files" id="filesBar">
      <div class="file-chip" style="opacity:.4;color:var(--muted);"><span class="fc-icon">â—‹</span>no documents loaded</div>
    </div>

    <div class="h-right">
      <div class="stat-pill"><span>CHATS</span><span class="stat-val" id="totalChats">0</span></div>
      <div class="stat-pill"><span>DOCS</span><span class="stat-val" id="sessionDocs">0</span></div>

      <div class="atw">
        <button class="atbtn" id="hAtBtn" onclick="onAttach('h')">
          <svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
        </button>
        <div class="attip" id="hAtTip">Attach documents to session</div>
      </div>

      <input type="file" id="fileInput" multiple accept=".xlsx,.csv,.pdf,.docx,.txt">
      <button class="new-chat-btn" onclick="newChat()">+ NEW CHAT</button>
    </div>
  </header>

  <div id="appLayout">
    <aside id="sidebar">
      <div class="sb-label">CONVERSATIONS</div>
      <div id="convList">
        <div style="padding:20px 12px;font-family:var(--fm);font-size:.65rem;color:var(--muted);">Loadingâ€¦</div>
      </div>
    </aside>

    <main id="chatMain">
      <div class="toolbar">
        <span class="tlabel">ROUTING</span>
        <div class="rdot sql"></div><span class="rtxt" style="color:var(--accent);">SQL</span>
        <div class="rdot doc"></div><span class="rtxt" style="color:var(--blue);">DOC</span>
        <div class="rdot hyb"></div><span class="rtxt" style="color:var(--yellow);">HYBRID</span>
        <span style="margin-left:auto;font-family:var(--fm);font-size:.6rem;color:var(--muted);">CTRL+ENTER TO SEND</span>
      </div>

      <div id="chatMessages">
        <div class="sess-ph" id="sessPh">
          <div class="sess-ph-grid"><span></span><span></span><span></span><span></span></div>
          <div class="sess-ph-title">ANALYST / READY</div>
          <div class="sess-ph-sub">Create a new chat to begin â€” attach documents and query your data with natural language</div>
        </div>
      </div>

      <div id="inputArea">
        <div class="input-row">
          <div class="iatw">
            <button class="iatbtn" id="iAtBtn" onclick="onAttach('i')">
              <svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
            </button>
            <div class="iattip" id="iAtTip">Attach documents to session</div>
          </div>
          <textarea id="messageInput" placeholder="query your dataâ€¦" rows="2"></textarea>
          <button id="sendBtn" onclick="sendMessage()">SEND â†’</button>
        </div>
        <div class="input-hint">
          <span>ðŸ“Ž ATTACH DOCS</span><span class="ih-sep">Â·</span>
          <span>CHARTS SUPPORTED</span><span class="ih-sep">Â·</span>
          <span>CTRL+ENTER TO SEND</span>
        </div>
      </div>
    </main>
  </div>

  <div id="statusBar">
    <div class="sb-item"><div class="sb-dot"></div><span>ONLINE</span></div>
    <span class="sb-sep">Â·</span>
    <span id="sbSession">NO SESSION</span>
    <span style="margin-left:auto;">ANALYST v2.0</span>
  </div>

</div>

<script>
'use strict';
let currentUserId='user_'+Math.random().toString(36).substr(2,9);
let currentConversationId=null;
let isLoading=false;
let chartInstances={};

/* â”€â”€ LAUNCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const BOOT=[
  {t:'sys',m:'[ ANALYST ] initializing runtimeâ€¦'},
  {t:'ok', m:'âœ“ session engine ready'},
  {t:'ok', m:'âœ“ RAG pipeline loaded'},
  {t:'ok', m:'âœ“ chart renderer ready'},
  {t:'info',m:'â†’ connecting to backendâ€¦'},
];

async function runBoot(){
  const c=document.getElementById('lsBoot');
  for(let i=0;i<BOOT.length;i++){
    await sleep(340+i*120);
    const d=document.createElement('div');
    d.className='boot-line '+BOOT[i].t;
    d.textContent=BOOT[i].m;
    c.appendChild(d);
  }
  await sleep(380);
  document.getElementById('lsBtn').disabled=false;
  document.getElementById('lsBtnTxt').textContent='â–· START SESSION';
}

function startApp(){
  const ls=document.getElementById('launchScreen');
  ls.classList.add('hiding');
  setTimeout(()=>{
    ls.style.display='none';
    const app=document.getElementById('mainApp');
    app.classList.add('visible');
    loadConversations();
    updateSessionBadge();
  },650);
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
window.addEventListener('load',runBoot);

/* â”€â”€ ATTACH BUTTON LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onAttach(src){
  if(!currentConversationId){
    const btnEl=document.getElementById(src==='h'?'hAtBtn':'iAtBtn');
    const tipEl=document.getElementById(src==='h'?'hAtTip':'iAtTip');
    // flash button
    btnEl.classList.remove('nosess');
    void btnEl.offsetWidth;
    btnEl.classList.add('nosess');
    btnEl.addEventListener('animationend',()=>btnEl.classList.remove('nosess'),{once:true});
    // update tip
    const orig=tipEl.textContent;
    tipEl.textContent='âš  Start a new session first!';
    tipEl.style.color='var(--red)';
    tipEl.style.opacity='1';
    tipEl.style.pointerEvents='none';
    setTimeout(()=>{tipEl.textContent=orig;tipEl.style.color='';tipEl.style.opacity='';},2200);
    showNotif('error','âš  Start a new session first â€” click + NEW CHAT');
    return;
  }
  document.getElementById('fileInput').click();
}

document.getElementById('fileInput').addEventListener('change',async(e)=>{
  await handleFiles(e.target.files);
  e.target.value='';
});

/* â”€â”€ FILE UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function handleFiles(files){
  if(!currentConversationId){showNotif('error','âš  Start a new session first');return;}
  const fd=new FormData();const fnames=[];
  Array.from(files).forEach(f=>{
    if(f.size>10*1024*1024){showNotif('error','âš  '+f.name+' >10MB');return;}
    fd.append('files',f);fnames.push(f.name);
  });
  if(!fnames.length)return;
  try{
    displayFiles(fnames.map(n=>({name:n,status:'processing'})));
    showNotif('info','â†‘ Uploading '+fnames.length+' file(s)â€¦');
    const res=await fetch('/upload',{method:'POST',headers:{'X-Conversation-ID':currentConversationId},body:fd});
    const r=await res.json();
    if(r.success||r.loaded_files){
      showNotif('success','âœ“ '+(r.loaded_files?.length||0)+' files loaded');
      displayFiles(r.loaded_files.map(n=>({name:n,status:'ready'})));
      updateSessionStats();
    } else {
      showNotif('error','âœ— '+(r.error||'Upload failed'));displayFiles([]);
    }
  } catch(e){showNotif('error','âœ— '+e.message);displayFiles([]);}
}

function displayFiles(files){
  const bar=document.getElementById('filesBar');
  if(!files||!files.length){
    bar.innerHTML='<div class="file-chip" style="opacity:.4;color:var(--muted);"><span class="fc-icon">â—‹</span>no documents loaded</div>';
    return;
  }
  bar.innerHTML='';
  files.forEach(f=>{
    const fname=typeof f==='string'?f:f.name;
    const st=f.status||'ready';
    const chip=document.createElement('div');chip.className='file-chip';
    chip.innerHTML=`<span class="fc-icon">${ficon(fname)}</span><span>${fname}</span><span class="fc-status ${st==='processing'?'fc-proc':''}">${st==='processing'?'â€¦':'âœ“'}</span>`;
    bar.appendChild(chip);
  });
}
function ficon(n){const e=(n.split('.').pop()||'').toLowerCase();return{xlsx:'â—ˆ',csv:'â—‡',pdf:'â–£',docx:'â–¤',txt:'â–¥'}[e]||'â–¦';}

/* â”€â”€ CONVERSATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function newChat(){
  try{
    const res=await fetch('/conversations',{method:'POST',headers:{'Content-Type':'application/json','X-User-ID':currentUserId},body:JSON.stringify({user_id:currentUserId,title:'New Chat'})});
    const r=await res.json();
    if(r.success){
      currentConversationId=r.conversation_id;
      clearChat();loadConversations();updateSessionStats();updateSessionBadge();
      showNotif('success','âœ“ New session started');
    }
  } catch(e){showNotif('error','âœ— Failed to create chat');}
}

async function loadConversations(){
  try{
    const res=await fetch('/conversations',{headers:{'X-User-ID':currentUserId}});
    const r=await res.json();
    const list=document.getElementById('convList');list.innerHTML='';
    if(!r.conversations.length){
      list.innerHTML='<div style="padding:20px 12px;font-family:var(--fm);font-size:.63rem;color:var(--muted);">NO CONVERSATIONS<br><span style="color:var(--border2);">â†’ click + NEW CHAT</span></div>';
      return;
    }
    r.conversations.forEach(conv=>{
      const item=document.createElement('div');
      item.className='conv-item'+(conv.conversation_id===currentConversationId?' active':'');
      const db=conv.documents>0?`<span class="doc-badge">âŠ¡ ${conv.documents}</span>`:'';
      item.innerHTML=`<div class="conv-title">${conv.title}</div><div class="conv-meta"><span>${conv.message_count} msgs</span>${db}<span>${fdate(conv.updated_at)}</span></div>`;
      item.onclick=()=>loadConversation(conv.conversation_id);
      list.appendChild(item);
    });
    document.getElementById('totalChats').textContent=r.conversations.length;
  } catch(e){console.error(e);}
}

async function loadConversation(id){
  try{
    const res=await fetch('/conversations/'+id);
    const r=await res.json();
    if(r.success){
      currentConversationId=id;
      const msgs=document.getElementById('chatMessages');msgs.innerHTML='';
      r.conversation.messages.forEach(m=>addMsg(m.role,m.content,m.routing,m.metadata));
      loadConversations();updateSessionStats();updateSessionBadge();
    }
  } catch(e){console.error(e);}
}

async function updateSessionStats(){
  if(!currentConversationId){document.getElementById('sessionDocs').textContent='0';displayFiles([]);return;}
  try{
    const res=await fetch('/conversations/'+currentConversationId+'/documents');
    const r=await res.json();
    if(r.success){
      document.getElementById('sessionDocs').textContent=r.total_documents;
      if(r.documents?.length)displayFiles(r.documents.map(n=>({name:n,status:'ready'})));
      else displayFiles([]);
    }
  } catch(e){console.error(e);}
}

function updateSessionBadge(){
  const id=currentConversationId;
  const s=id?id.substring(0,8).toUpperCase()+'â€¦':'â€”';
  document.getElementById('currentSessionBadge').textContent=s;
  document.getElementById('sbSession').textContent=id?'SESSION '+s:'NO SESSION';
}

/* â”€â”€ MARKDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderMD(text){
  if(!text)return'';
  try{
    marked.setOptions({breaks:true,gfm:true,headerIds:false,mangle:false,pedantic:false});
    return marked.parse(text.trim().replace(/\r\n/g,'\n'));
  } catch(e){return fbMD(text);}
}
function fbMD(t){
  let h=t;
  h=h.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  h=h.replace(/__(.+?)__/g,'<strong>$1</strong>');
  h=h.replace(/\*(.+?)\*/g,'<em>$1</em>');
  h=h.replace(/^### (.+)$/gm,'<h3>$1</h3>');
  h=h.replace(/^## (.+)$/gm,'<h2>$1</h2>');
  h=h.replace(/^# (.+)$/gm,'<h1>$1</h1>');
  h=h.replace(/^- (.+)$/gm,'<li>$1</li>');
  h=h.replace(/(<li>.*<\/li>\n?)+/g,'<ul>$&</ul>');
  h=h.replace(/\n/g,'<br>');
  return h;
}

/* â”€â”€ CHARTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderChart(pd,mid){
  const box=document.createElement('div');box.className='chart-box';
  const cv=document.createElement('canvas');
  const cid='chart-'+mid+'-'+Date.now();cv.id=cid;
  box.appendChild(cv);
  const dl=document.createElement('button');dl.className='chart-dl';dl.innerHTML='â†“ EXPORT PNG';
  dl.onclick=()=>dlChart(cv,pd.title);box.appendChild(dl);
  setTimeout(()=>makeChart(cv,pd,cid),100);
  return box;
}
function makeChart(cv,pd,cid){
  const ctx=cv.getContext('2d');
  if(chartInstances[cid])chartInstances[cid].destroy();
  const pal=['#4ade80','#38bdf8','#fbbf24','#f87171','#a78bfa','#fb923c','#34d399','#818cf8'];
  const isPie=pd.type==='pie'||pd.type==='doughnut';
  chartInstances[cid]=new Chart(ctx,{
    type:pd.type,
    data:{
      labels:pd.x,
      datasets:[{label:pd.y_label,data:pd.y,
        backgroundColor:isPie?pal.slice(0,pd.x.length).map(c=>c+'aa'):'#4ade8033',
        borderColor:isPie?pal.slice(0,pd.x.length):'#4ade80',
        borderWidth:1.5,tension:0.4}]
    },
    options:{
      responsive:true,maintainAspectRatio:true,
      plugins:{
        title:{display:true,text:pd.title,color:'#86efac',font:{family:"'IBM Plex Mono'",size:13,weight:'600'},padding:{bottom:18}},
        legend:{display:isPie,labels:{color:'#8890b0',font:{family:"'IBM Plex Mono'",size:11}}},
        tooltip:{backgroundColor:'#111320',borderColor:'#252840',borderWidth:1,titleColor:'#4ade80',bodyColor:'#d4d8f0',titleFont:{family:"'IBM Plex Mono'"},bodyFont:{family:"'IBM Plex Mono'",size:12}}
      },
      scales:isPie?{}:{
        x:{ticks:{color:'#4a5066',font:{family:"'IBM Plex Mono'",size:11}},grid:{color:'#1c1f2e'},title:{display:true,text:pd.x_label,color:'#6b7291',font:{family:"'IBM Plex Mono'",size:11}}},
        y:{ticks:{color:'#4a5066',font:{family:"'IBM Plex Mono'",size:11},callback:v=>fmtN(v)},grid:{color:'#1c1f2e'},title:{display:true,text:pd.y_label,color:'#6b7291',font:{family:"'IBM Plex Mono'",size:11}},beginAtZero:true}
      }
    }
  });
}
function dlChart(cv,title){
  const a=document.createElement('a');
  a.download=(title||'chart').replace(/[^a-z0-9]/gi,'_')+'.png';
  a.href=cv.toDataURL('image/png');a.click();
  showNotif('success','â†“ Chart exported');
}
function fmtN(n){
  if(typeof n!=='number')return n;
  if(n>=1e6)return(n/1e6).toFixed(1)+'M';
  if(n>=1e3)return(n/1e3).toFixed(1)+'K';
  return n.toLocaleString();
}

/* â”€â”€ MESSAGING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function sendMessage(){
  const inp=document.getElementById('messageInput');
  const msg=inp.value.trim();
  if(!msg||isLoading)return;
  if(!currentConversationId){showNotif('error','âš  Start a new session first');return;}
  addMsg('user',msg);inp.value='';
  isLoading=true;document.getElementById('sendBtn').disabled=true;
  try{
    const res=await fetch('/query',{method:'POST',headers:{'Content-Type':'application/json','X-User-ID':currentUserId},body:JSON.stringify({question:msg,conversation_id:currentConversationId})});
    const r=await res.json();
    if(r.success){addMsg('assistant',r.explanation||r.answer||'No answer',r.routing,null,r.plot);loadConversations();}
    else addMsg('assistant','âœ— Error: '+r.error);
  } catch(e){addMsg('assistant','âœ— Error: '+e.message);}
  finally{isLoading=false;document.getElementById('sendBtn').disabled=false;}
}

function addMsg(role,content,routing,meta,plotData){
  const msgs=document.getElementById('chatMessages');
  const ph=document.getElementById('sessPh');if(ph)ph.remove();
  const mid=Date.now();
  const group=document.createElement('div');group.className='msg-group';
  // header
  const hdr=document.createElement('div');hdr.className='msg-hdr';
  let rtag='';
  if(routing){const cls=routing==='sql'?'rtag-sql':routing==='document'?'rtag-doc':'rtag-hyb';rtag=`<span class="rtag ${cls}">${routing.toUpperCase()}</span>`;}
  hdr.innerHTML=`<span class="msg-role ${role}">${role==='user'?'â–¸ USER':'â—ˆ ANALYST'}</span><span>${new Date().toLocaleTimeString('en',{hour12:false})}</span>${rtag}`;
  // bubble
  const bubble=document.createElement('div');bubble.className='msg-bubble '+role;
  if(plotData)bubble.appendChild(renderChart(plotData,mid));
  const cd=document.createElement('div');cd.className='mc';
  if(role==='assistant')cd.innerHTML=renderMD(content);
  else cd.textContent=content;
  bubble.appendChild(cd);
  group.appendChild(hdr);group.appendChild(bubble);
  msgs.appendChild(group);msgs.scrollTop=msgs.scrollHeight;
}

function clearChat(){
  const msgs=document.getElementById('chatMessages');
  msgs.innerHTML=`<div class="sess-ph" id="sessPh"><div class="sess-ph-grid"><span></span><span></span><span></span><span></span></div><div class="sess-ph-title">NEW SESSION / READY</div><div class="sess-ph-sub">Attach documents or start querying your data</div></div>`;
  displayFiles([]);
}

/* â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showNotif(type,message){
  const n=document.createElement('div');n.className='notif '+type;n.textContent=message;
  document.body.appendChild(n);
  setTimeout(()=>{n.style.opacity='0';n.style.transition='opacity .3s';setTimeout(()=>n.remove(),300);},2700);
}

function fdate(d){
  const diff=(new Date()-new Date(d))/1000;
  if(diff<60)return'NOW';if(diff<3600)return Math.floor(diff/60)+'M';
  if(diff<86400)return Math.floor(diff/3600)+'H';return Math.floor(diff/86400)+'D';
}

/* â”€â”€ KEYBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.getElementById('messageInput').addEventListener('keydown',e=>{
  if(e.key==='Enter'&&e.ctrlKey){e.preventDefault();sendMessage();}
});
</script>
</body>
</html>
